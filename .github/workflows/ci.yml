name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: uv sync
      
    - name: ğŸ” Run Ruff linter
      id: ruff
      run: |
        echo "Running Ruff linter..."
        uv run ruff check --output-format=github
      continue-on-error: true
      
    - name: ğŸ¨ Check code formatting with Black
      id: black
      run: |
        echo "Checking code formatting..."
        uv run black . --check --diff --color
      continue-on-error: true
      
    - name: ğŸ“ Type checking with mypy (optional)
      id: mypy
      run: |
        echo "Running type checking..."
        uv run mypy src/ --ignore-missing-imports || echo "âš ï¸ mypy not configured or failed"
      continue-on-error: true
      
    - name: ğŸ“Š Code Quality Summary
      run: |
        echo "## ğŸ“Š Code Quality Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.ruff.outcome }}" == "success" ]; then
          echo "âœ… **Ruff linting**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Ruff linting**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.black.outcome }}" == "success" ]; then
          echo "âœ… **Black formatting**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Black formatting**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ› ï¸ How to fix issues:" >> $GITHUB_STEP_SUMMARY
        echo "- **Fix linting**: \`uv run ruff check --fix\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Fix formatting**: \`uv run black .\`" >> $GITHUB_STEP_SUMMARY
        
    - name: âŒ Fail if quality checks failed
      if: steps.ruff.outcome == 'failure' || steps.black.outcome == 'failure'
      run: |
        echo "ğŸ’¥ Code quality checks failed!"
        echo "Please run the following commands to fix issues:"
        echo "  uv run ruff check --fix"
        echo "  uv run black ."
        exit 1
        
    - name: âœ… All checks passed
      if: steps.ruff.outcome == 'success' && steps.black.outcome == 'success'
      run: echo "ğŸ‰ All code quality checks passed!"

  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: ğŸ”’ Run security scan with bandit
      run: |
        uv add --dev bandit
        uv run bandit -r src/ -f json || echo "âš ï¸ Security scan completed with warnings"
      continue-on-error: true
